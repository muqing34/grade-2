<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>游戏进行中 - 心理文字游戏</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

<!-- 导航栏 -->
<nav class="bg-white shadow-md">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between h-16">
            <div class="flex">
                <div class="flex-shrink-0 flex items-center text-xl font-bold text-blue-600">
                    心理冒险
                </div>
                <div class="hidden sm:ml-6 sm:flex sm:space-x-8">
                    <a href="game.html" class="border-blue-500 text-gray-900 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                        游戏
                    </a>
                    <a href="knowledge.html" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                        心理科普
                    </a>
                    <a href="profile.html" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                        个人资料
                    </a>
                </div>
            </div>
            <div class="flex items-center">
                <button id="logout-button" class="bg-red-600 text-white px-3 py-1.5 rounded-md text-sm font-medium hover:bg-red-700 transition">
                    登出
                </button>
            </div>
        </div>
    </div>
</nav>

<!-- 游戏内容区 -->
<div class="py-10">
    <header class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <h1 class="text-3xl font-bold leading-tight text-gray-900">你的旅程</h1>
    </header>
    <main>
        <div class="max-w-7xl mx-auto sm:px-6 lg:px-8 mt-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">

                <!-- 玩家状态 -->
                <div class="md:col-span-1">
                    <div class="bg-white shadow-lg rounded-lg p-6">
                        <h3 class="text-xl font-semibold mb-4 text-gray-900">玩家状态</h3>
                        <div id="attributes-list" class="space-y-3">
                            <p class="text-gray-600">正在加载属性...</p>
                        </div>
                        <button id="reset-button" class="w-full mt-6 bg-yellow-500 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-yellow-600 transition">
                            重置游戏
                        </button>
                    </div>
                </div>

                <!-- 游戏节点 -->
                <div class="md:col-span-2">
                    <div class="bg-white shadow-lg rounded-lg p-6 min-h-[300px]">
                        <h3 class="text-xl font-semibold mb-4 text-gray-900">当前情景</h3>
                        <div id="game-content" class="text-gray-700 leading-relaxed mb-6">
                            <p>正在加载游戏内容...</p>
                        </div>

                        <h4 class="text-lg font-semibold mb-4 text-gray-800">你的选择：</h4>
                        <div id="choices-list" class="space-y-3">
                            <!-- 选项将动态插入这里 -->
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </main>
</div>

<!-- 全局JS -->
<script>
    // --- 认证与API工具 ---
    const API_BASE = ''; // 假设和前端同源

    function getToken() {
        return localStorage.getItem('jwtToken');
    }

    function logout() {
        localStorage.removeItem('jwtToken');
        window.location.href = 'index.html';
    }

    // 检查是否登录，未登录则踢回登录页
    function checkAuth() {
        if (!getToken()) {
            console.log('未找到Token，正在重定向到登录页...');
            logout();
        }
    }

    async function fetchWithAuth(url, options = {}) {
        const token = getToken();
        if (!token) {
            logout();
            throw new Error('用户未认证');
        }

        const headers = {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`,
            ...options.headers,
        };

        const response = await fetch(API_BASE + url, { ...options, headers });

        if (response.status === 401 || response.status === 403) {
            // Token无效或过期
            logout();
            throw new Error('认证失败，请重新登录');
        }

        return response;
    }

    // --- 页面逻辑 ---
    document.addEventListener('DOMContentLoaded', () => {
        checkAuth();
        loadGameData();

        document.getElementById('logout-button').addEventListener('click', logout);
        document.getElementById('reset-button').addEventListener('click', resetGame);
    });

    const attributesList = document.getElementById('attributes-list');
    const gameContent = document.getElementById('game-content');
    const choicesList = document.getElementById('choices-list');

    async function loadGameData() {
        try {
            // 同时获取状态和节点
            const [stateRes, nodeRes] = await Promise.all([
                fetchWithAuth('/api/game/state'),
                fetchWithAuth('/api/game/current-node')
            ]);

            if (!stateRes.ok || !nodeRes.ok) {
                throw new Error('加载游戏数据失败');
            }

            const state = await stateRes.json();
            const node = await nodeRes.json();

            renderAttributes(state.attributes.attributes);
            renderGameNode(node);

        } catch (error) {
            console.error('加载游戏失败:', error);
            gameContent.innerHTML = `<p class="text-red-500">${error.message}</p>`;
        }
    }

    function renderAttributes(attrs) {
        attributesList.innerHTML = '';
        if (Object.keys(attrs).length === 0) {
            attributesList.innerHTML = '<p class="text-gray-500">暂无属性</p>';
            return;
        }
        for (const [key, value] of Object.entries(attrs)) {
            const attrEl = document.createElement('div');
            attrEl.className = 'flex justify-between items-center bg-gray-50 p-3 rounded-md';
            attrEl.innerHTML = `
                <span class="text-gray-700 font-medium capitalize">${key}</span>
                <span class="text-blue-600 font-bold text-lg">${value}</span>
            `;
            attributesList.appendChild(attrEl);
        }
    }

    function renderGameNode(node) {
        // 渲染情景
        gameContent.innerHTML = `<p>${node.content.replace(/\n/g, '<br>')}</p>`;

        // 渲染选项
        choicesList.innerHTML = '';
        if (!node.choices || node.choices.length === 0) {
            choicesList.innerHTML = '<p class="text-gray-500">--- 旅程已达终点 ---</p>';
            return;
        }

        node.choices.forEach(choice => {
            const choiceButton = document.createElement('button');
            choiceButton.className = 'w-full px-4 py-3 font-semibold text-white bg-blue-600 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200 text-left';
            choiceButton.textContent = choice.text;

            // 添加属性要求提示
            if (choice.requiredAttributes) {
                let reqText = [];
                for (const [key, value] of Object.entries(choice.requiredAttributes)) {
                    reqText.push(`${key} > ${value-1}`);
                }
                choiceButton.innerHTML += ` <span class="text-xs text-blue-200">(${reqText.join(', ')})</span>`;
            }

            choiceButton.onclick = () => makeChoice(choice.choiceId);
            choicesList.appendChild(choiceButton);
        });
    }

    async function makeChoice(choiceId) {
        try {
            const response = await fetchWithAuth('/api/game/choice', {
                method: 'POST',
                body: JSON.stringify({ choiceId }),
            });

            if (!response.ok) {
                throw new Error('选择失败');
            }

            // 选择成功后，重新加载游戏数据
            loadGameData();

        } catch (error) {
            console.error('选择时发生错误:', error);
            // 可以在这里显示一个短暂的错误提示
        }
    }

    async function resetGame() {
        if (!confirm('确定要重置游戏吗？所有进度将丢失。')) {
            return;
        }
        try {
            await fetchWithAuth('/api/game/reset', { method: 'POST' });
            // 重置成功后重新加载
            loadGameData();
        } catch (error) {
            console.error('重置游戏失败:', error);
        }
    }

</script>
</body>
</html>
