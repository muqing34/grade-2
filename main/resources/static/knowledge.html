<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>心理学科普 - 心理文字游戏</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* 弹窗样式 */
        .modal {
            transition: opacity 0.25s ease;
        }
        .modal-content {
            transition: transform 0.25s ease;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

<!-- 导航栏 -->
<nav class="bg-white shadow-md">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between h-16">
            <div class="flex">
                <div class="flex-shrink-0 flex items-center text-xl font-bold text-blue-600">
                    心理冒险
                </div>
                <!-- 修复2：移除 'hidden' 并调整间距和字体大小，使其在移动端可见 -->
                <div class="ml-2 sm:ml-6 flex items-center space-x-1 sm:space-x-8">
                    <a href="game.html" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 sm:px-1 pt-1 border-b-2 text-xs sm:text-sm font-medium">
                        游戏
                    </a>
                    <a href="ai-chat.html" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 sm:px-1 pt-1 border-b-2 text-xs sm:text-sm font-medium">
                        AI助手
                    </a>
                    <a href="knowledge.html" class="border-blue-500 text-gray-900 inline-flex items-center px-1 sm:px-1 pt-1 border-b-2 text-xs sm:text-sm font-medium">
                        心理科普
                    </a>
                    <a href="profile.html" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 sm:px-1 pt-1 border-b-2 text-xs sm:text-sm font-medium">
                        个人资料
                    </a>
                </div>
            </div>
            <div class="flex items-center">
                <button id="auth-button" class="bg-blue-600 text-white px-3 py-1.5 rounded-md text-sm font-medium hover:bg-blue-700 transition">
                    <!-- JS会填充内容 -->
                </button>
            </div>
        </div>
    </div>
</nav>

<!-- 内容区 -->
<div class="py-10">
    <header class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <h1 class="text-3xl font-bold leading-tight text-gray-900">心理学科普</h1>
        <!-- (已更新) 描述 -->
        <p class="mt-2 text-gray-600">搜索本地心理知识库。</p>
        <!-- 搜索栏 -->
        <div class="mt-4 flex">
            <input type="text" id="search-query" placeholder="输入关键词 (如: 强迫症)"
                   class="flex-grow px-3 py-2 border border-gray-300 rounded-l-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
            <button id="search-button"
                    class="px-4 py-2 font-semibold text-white bg-blue-600 rounded-r-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1 transition duration-200">
                搜索
            </button>
        </div>
    </header>
    <main>
        <div class="max-w-7xl mx-auto sm:px-6 lg:px-8 mt-6">
            <div id="articles-list" class="space-y-6">
                <!-- 文章列表将动态加载于此 -->
                <p class="text-gray-500">正在加载知识库...</p>
            </div>
            <!-- (已更新) 分页 -->
            <div id="pagination" class="mt-6 flex justify-between items-center hidden">
                <button id="prev-page" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed">
                    &larr; 上一页
                </button>
                <span id="page-info" class="text-sm text-gray-600"></span>
                <button id="next-page" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed">
                    下一页 &rarr;
                </button>
            </div>
        </div>
    </main>
</div>

<!-- (新) 知识详情弹窗 (Modal) -->
<div id="article-modal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 opacity-0 pointer-events-none">
    <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-3xl transform -translate-y-10 scale-95">
        <!-- 头部 -->
        <div class="flex justify-between items-center p-4 border-b">
            <h3 id="modal-title" class="text-2xl font-semibold text-gray-900"></h3>
            <button id="modal-close" class="text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
        </div>
        <!-- 内容 -->
        <div id="modal-content" class="p-6 max-h-[70vh] overflow-y-auto">
            <!-- 内容将动态填充 -->
        </div>
        <!-- 底部 -->
        <div class="p-4 bg-gray-50 rounded-b-lg text-right">
            <button id="modal-close-bottom" class="px-4 py-2 font-semibold text-white bg-blue-600 rounded-md hover:bg-blue-700 transition">
                关闭
            </button>
        </div>
    </div>
</div>


<script>
    // (已更新) 状态变量
    let currentPage = 1;
    let currentQuery = '';
    let totalPages = 1;
    const resultsPerPage = 10;
    let allArticles = []; // (新) 缓存当前页的文章

    // (新) Modal 元素
    const modal = document.getElementById('article-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalContent = document.getElementById('modal-content');
    const modalClose = document.getElementById('modal-close');
    const modalCloseBottom = document.getElementById('modal-close-bottom');


    document.addEventListener('DOMContentLoaded', () => {
        setupAuthButton();

        // (已更新) 页面加载时自动搜索一次 (显示全部)
        searchArticles();

        document.getElementById('search-button').addEventListener('click', () => {
             currentQuery = document.getElementById('search-query').value.trim();
             currentPage = 1; // 新搜索从第一页开始
             searchArticles();
        });

        document.getElementById('prev-page').addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                searchArticles();
            }
        });
        document.getElementById('next-page').addEventListener('click', () => {
             if (currentPage < totalPages) { // 检查是否有下一页
                 currentPage++;
                 searchArticles();
             }
        });

        // (新) 绑定弹窗关闭事件
        modalClose.onclick = closeModal;
        modalCloseBottom.onclick = closeModal;
        modal.onclick = (e) => {
            if (e.target === modal) {
                closeModal();
            }
        };
    });

    // 设置右上角按钮（登录/登出）
    function setupAuthButton() {
        const token = localStorage.getItem('jwtToken');
        const authButton = document.getElementById('auth-button');
        if (token) {
            authButton.textContent = '登出';
            authButton.className = 'bg-red-600 text-white px-3 py-1.5 rounded-md text-sm font-medium hover:bg-red-700 transition';
            authButton.onclick = () => {
                localStorage.removeItem('jwtToken');
                window.location.href = '/index.html'; // 使用根相对路径
            };
        } else {
            authButton.textContent = '登录';
            authButton.className = 'bg-blue-600 text-white px-3 py-1.5 rounded-md text-sm font-medium hover:bg-blue-700 transition';
            authButton.onclick = () => {
                window.location.href = '/index.html'; // 使用根相对路径
            };
        }
    }

    // (已更新) 搜索文章
    async function searchArticles() {
        const articlesList = document.getElementById('articles-list');
        const pagination = document.getElementById('pagination');
        articlesList.innerHTML = '<p class="text-gray-500">正在搜索...</p>'; // 显示加载状态
        pagination.classList.add('hidden'); // 隐藏分页

        try {
            // (已更新) API URL
            const apiUrl = `/api/knowledge/search?query=${encodeURIComponent(currentQuery)}&page=${currentPage}&perPage=${resultsPerPage}`;

            // 注意：这个 API 是公开的，不需要 token
            const response = await fetch(apiUrl);

            if (!response.ok) {
                 if(response.status === 404 || response.status === 204) { // 204 = No Content
                     throw new Error('没有找到相关文章。');
                 }
                throw new Error(`无法加载文章 (${response.status})`);
            }

            const data = await response.json(); // (已更新) 响应体是 Page<KnowledgeArticle>
            totalPages = data.totalPages || 1; // 更新总页数
            allArticles = data.content; // (新) 缓存文章
            renderArticles(allArticles); // (已更新) 渲染 data.content
            updatePagination(data); // (已更新) 传入整个 data 对象

        } catch (error) {
            console.error('加载文章失败:', error);
            articlesList.innerHTML = `<p class="text-red-500">加载文章失败：${error.message}</p>`;
        }
    }

    // (已更新) 渲染从本地数据库获取的文章
    function renderArticles(articles) {
        const articlesList = document.getElementById('articles-list');
        articlesList.innerHTML = ''; // 清空加载提示

        if (!articles || articles.length === 0) {
            articlesList.innerHTML = '<p class="text-gray-500">没有找到相关文章。</p>';
            return;
        }

        articles.forEach((article, index) => { // (新) 添加 index
            const articleEl = document.createElement('div');
            articleEl.className = 'bg-white shadow-lg rounded-lg p-6 hover:shadow-xl transition-shadow duration-300';

            const title = article.title || '无标题';
            const category = article.category || '无分类';
            const summary = article.summary || '无摘要';

            articleEl.innerHTML = `
                <h3 class="text-xl font-semibold mb-2 text-blue-700">${title}</h3>
                <p class="text-sm text-gray-500 mb-1">类别: <span class="font-medium text-gray-700">${category}</span></p>
                <p class="text-gray-600 mb-3">${summary}</p>
                <!-- (新) 添加 "阅读全文" 按钮，并绑定 openModal 事件 -->
                <button onclick="openModal(${index})" class="text-sm font-medium text-blue-600 hover:text-blue-800">
                    阅读全文 &rarr;
                </button>
            `;
            articlesList.appendChild(articleEl);
        });
    }

     // (已更新) 更新分页信息和按钮状态
    function updatePagination(data) {
        const pagination = document.getElementById('pagination');
        const pageInfo = document.getElementById('page-info');
        const prevButton = document.getElementById('prev-page');
        const nextButton = document.getElementById('next-page');

        if (data && data.totalElements > 0) {
             // (已更新) data.number 是从0开始的页码
             const currentPageNum = data.number + 1;
             totalPages = data.totalPages;
             pageInfo.textContent = `第 ${currentPageNum} 页 / 共 ${totalPages} 页 (共 ${data.totalElements} 条结果)`;

             prevButton.disabled = data.first; // (已更新) 使用 Spring Page 的 'first' 属性
             nextButton.disabled = data.last; // (已更新) 使用 Spring Page 的 'last' 属性

             pagination.classList.remove('hidden');
        } else {
             pagination.classList.add('hidden'); // 没有结果则隐藏分页
        }
    }

    // (新) --- 弹窗 Modal 逻辑 ---

    // (新) 简单 Markdown 转换
    function simpleMarkdownToHtml(md) {
        if (!md) return '';
        return md
            .replace(/# (.*)/g, '<h1 class="text-2xl font-bold mb-4">$1</h1>')
            .replace(/## (.*)/g, '<h2 class="text-xl font-semibold mt-4 mb-2">$1</h2>')
            .replace(/### (.*)/g, '<h3 class="text-lg font-semibold mt-3 mb-1">$1</h3>')
            .replace(/\* (.*)/g, '<li class="ml-5 list-disc">$1</li>')
            .replace(/\* (.*)/g, '<li class="ml-5 list-disc">$1</li>')
            .replace(/\n/g, '<br />'); // 转换换行
    }

    // (新) 打开弹窗
    function openModal(index) {
        const article = allArticles[index];
        if (!article) return;

        modalTitle.textContent = article.title;
        // (新) 使用 Markdown 转换
        modalContent.innerHTML = simpleMarkdownToHtml(article.content);

        modal.classList.remove('opacity-0', 'pointer-events-none');
        modal.querySelector('.modal-content').classList.remove('-translate-y-10', 'scale-95');
    }

    // (新) 关闭弹窗
    function closeModal() {
        modal.classList.add('opacity-0', 'pointer-events-none');
        modal.querySelector('.modal-content').classList.add('-translate-y-10', 'scale-95');
    }
</script>
</body>
</html>